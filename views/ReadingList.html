<!doctype html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Minimal example of using Lovefield</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lovefield/2.1.12/lovefield.min.js"></script>
</head>
<body>
<script>
    var RRrawJSON = [
        {
            "id": 1,
            "bookId": 1,
            "currentPage": 162
        },
        {
            "id": 2,
            "bookId": 2,
            "currentPage": 104
        },
        {
            "id": 3,
            "bookId": 1,
            "currentPage": 21
        }
    ];

    var BLrawJSON = [
        {
            id: 1,
            book: 'Get a cup of coffee',
            author: 'Steve',
            description: 'A true story',
            length: 1
        }
        , {
            id: 2,
            book: 'Get a cup of coffee 2',
            author: 'Steve-o',
            description: 'A fake story',
            length: 1
        }
    ];

    console.log('1');
    var schemaBuilder = lf.schema.create('SDGReading', 1);

    schemaBuilder.createTable('ReadingRecord').
    addColumn('id', lf.Type.INTEGER).
    addColumn('bookId', lf.Type.INTEGER).
    addColumn('currentPage', lf.Type.INTEGER).
    addForeignKey('fk_Book', {
        local: 'bookId',
        ref: 'Book.id',
        action: lf.ConstraintAction.CASCADE
    }).
    addPrimaryKey(['id']);

    schemaBuilder.createTable('Book').
    addColumn('id', lf.Type.INTEGER).
    addColumn('book', lf.Type.STRING).
    addColumn('author', lf.Type.STRING).
    addColumn('description', lf.Type.STRING).
    addColumn('length', lf.Type.INTEGER).
    addPrimaryKey(['id']);

    var todoDb;
    var ReadingRecord;
    var bookDB;
    schemaBuilder.connect().then(function (db) {
        todoDb = db;
        ReadingRecord = db.getSchema().table('ReadingRecord');
        bookDB = db.getSchema().table('Book');
        var row = RRrawJSON.map(function (obj) {
            return ReadingRecord.createRow(obj);
        });

        var bookRow = BLrawJSON.map(function (obj) {
            return bookDB.createRow(obj);
        });
        var q1 = todoDb.insertOrReplace().into(ReadingRecord).values(row);
        var q2 = todoDb.insertOrReplace().into(bookDB).values(bookRow);

        var tx = todoDb.createTransaction();
        return tx.exec([q2, q1]);
    }).then(function (results) {
        results[0].forEach(function (row) {
            console.log(row['book'], 'before', row['author']);
        });
        results[1].forEach(function (row) {
            console.log(row['bookId'], 'before', row['author']);
        });
    });

</script>
</body>
</html>
